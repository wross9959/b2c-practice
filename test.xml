<?xml version="1.0" encoding="UTF-8"?>


  <BuildingBlocks>

    <ClaimsSchema>

      <!-- Invite params / URL params -->
      <ClaimType Id="email">
        <DisplayName>Email</DisplayName>
        <DataType>string</DataType>
        <UserInputType>Readonly</UserInputType>
      </ClaimType>

      <ClaimType Id="displayName">
        <DisplayName>Display Name</DisplayName>
        <DataType>string</DataType>
        <UserInputType>Readonly</UserInputType>
      </ClaimType>

      <ClaimType Id="givenName">
        <DisplayName>Given Name</DisplayName>
        <DataType>string</DataType>
        <UserInputType>Readonly</UserInputType>
      </ClaimType>

      <ClaimType Id="surname">
        <DisplayName>Surname</DisplayName>
        <DataType>string</DataType>
        <UserInputType>Readonly</UserInputType>
      </ClaimType>

      <!-- Standard -->
      <ClaimType Id="objectId">
        <DisplayName>Object Id</DisplayName>
        <DataType>string</DataType>
      </ClaimType>

      <ClaimType Id="newPassword">
        <DisplayName>New Password</DisplayName>
        <DataType>string</DataType>
        <UserInputType>Password</UserInputType>
      </ClaimType>

      <ClaimType Id="reenterPassword">
        <DisplayName>Confirm Password</DisplayName>
        <DataType>string</DataType>
        <UserInputType>Password</UserInputType>
      </ClaimType>

      <ClaimType Id="authenticationSource">
        <DisplayName>Authentication Source</DisplayName>
        <DataType>string</DataType>
      </ClaimType>

      <ClaimType Id="executed-SelfAsserted-Input">
        <DisplayName>Executed Self Asserted</DisplayName>
        <DataType>boolean</DataType>
      </ClaimType>

      <ClaimType Id="newUser">
        <DisplayName>New User</DisplayName>
        <DataType>boolean</DataType>
      </ClaimType>

      <ClaimType Id="userPrincipalName">
        <DisplayName>UPN</DisplayName>
        <DataType>string</DataType>
      </ClaimType>

      <ClaimType Id="signInNames.emailAddress">
        <DisplayName>Sign-in Email</DisplayName>
        <DataType>string</DataType>
      </ClaimType>

    </ClaimsSchema>

  </BuildingBlocks>

  <ClaimsProviders>

    <!-- 1) Step 0 helper: read email (and optional names) from the URL into the claims bag -->
    <ClaimsProvider>
      <DisplayName>Invite Params</DisplayName>
      <TechnicalProfiles>
        <TechnicalProfile Id="GetInviteParamsFromUrl">
          <DisplayName>Get invite params from query string</DisplayName>
          <Protocol Name="Proprietary"
            Handler="Web.TPEngine.Providers.ClaimsTransformationProtocolProvider, Web.TPEngine, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null" />

          <!-- This is the key: put values into the claims bag as OutputClaims -->
          <OutputClaims>
            <OutputClaim ClaimTypeReferenceId="email" DefaultValue="{OAUTH-KV:email}" AlwaysUseDefaultValue="true" />
            <OutputClaim ClaimTypeReferenceId="displayName" DefaultValue="{OAUTH-KV:displayname}" AlwaysUseDefaultValue="true" />
            <OutputClaim ClaimTypeReferenceId="givenName" DefaultValue="{OAUTH-KV:firstName}" AlwaysUseDefaultValue="true" />
            <OutputClaim ClaimTypeReferenceId="surname" DefaultValue="{OAUTH-KV:lastName}" AlwaysUseDefaultValue="true" />
          </OutputClaims>

        </TechnicalProfile>
      </TechnicalProfiles>
    </ClaimsProvider>

    <!-- 2) Local Account: Signup UI (email locked, prefilled) -->
    <ClaimsProvider>
      <DisplayName>Local Account</DisplayName>
      <TechnicalProfiles>

        <TechnicalProfile Id="SelfAsserted-LocalAccount-Signup-EmailPrefill">
          <DisplayName>Create Account</DisplayName>

          <Protocol Name="Proprietary"
            Handler="Web.TPEngine.Providers.SelfAssertedAttributeProvider, Web.TPEngine, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null" />

          <Metadata>
            <Item Key="ContentDefinitionReferenceId">api.localaccountsignup</Item>
            <Item Key="IpAddressClaimReferenceId">IpAddress</Item>
            <Item Key="IncludeClaimResolvingInClaimsHandling">true</Item>
            <Item Key="language.button_continue">Create</Item>
            <Item Key="EnforceEmailVerification">false</Item>
          </Metadata>

          <CryptographicKeys>
            <Key Id="issuer_secret" StorageReferenceId="B2C_1A_TokenSigningKeyContainer" />
          </CryptographicKeys>

          <!-- Take values already in claims bag (from Step 0) and keep them locked -->
          <InputClaims>
            <InputClaim ClaimTypeReferenceId="email" DefaultValue="{Claim:email}" AlwaysUseDefaultValue="true" />
            <InputClaim ClaimTypeReferenceId="displayName" DefaultValue="{Claim:displayName}" AlwaysUseDefaultValue="true" />
            <InputClaim ClaimTypeReferenceId="givenName" DefaultValue="{Claim:givenName}" AlwaysUseDefaultValue="true" />
            <InputClaim ClaimTypeReferenceId="surname" DefaultValue="{Claim:surname}" AlwaysUseDefaultValue="true" />
          </InputClaims>

          <DisplayClaims>
            <DisplayClaim ClaimTypeReferenceId="email" Required="true" />
            <DisplayClaim ClaimTypeReferenceId="newPassword" Required="true" />
            <DisplayClaim ClaimTypeReferenceId="reenterPassword" Required="true" />
            <DisplayClaim ClaimTypeReferenceId="displayName" Required="true" />
            <DisplayClaim ClaimTypeReferenceId="givenName" Required="true" />
            <DisplayClaim ClaimTypeReferenceId="surname" Required="true" />
          </DisplayClaims>

          <OutputClaims>
            <OutputClaim ClaimTypeReferenceId="objectId" />
            <OutputClaim ClaimTypeReferenceId="email" DefaultValue="{Claim:email}" AlwaysUseDefaultValue="true" />
            <OutputClaim ClaimTypeReferenceId="displayName" />
            <OutputClaim ClaimTypeReferenceId="givenName" />
            <OutputClaim ClaimTypeReferenceId="surname" />
            <OutputClaim ClaimTypeReferenceId="newPassword" Required="true" />
            <OutputClaim ClaimTypeReferenceId="reenterPassword" Required="true" />
            <OutputClaim ClaimTypeReferenceId="executed-SelfAsserted-Input" DefaultValue="true" />
            <OutputClaim ClaimTypeReferenceId="authenticationSource" />
            <OutputClaim ClaimTypeReferenceId="newUser" />
          </OutputClaims>

          <ValidationTechnicalProfiles>
            <ValidationTechnicalProfile ReferenceId="AAD-UserWriteUsingLogonEmail" />
          </ValidationTechnicalProfiles>

          <UseTechnicalProfileForSessionManagement ReferenceId="SM-AAD" />
        </TechnicalProfile>

        <!-- 3) AAD write with “email already exists” message -->
        <TechnicalProfile Id="AAD-UserWriteUsingLogonEmail">
          <Metadata>
            <Item Key="Operation">Write</Item>
            <Item Key="RaiseErrorIfClaimsPrincipalAlreadyExists">true</Item>
            <Item Key="UserMessageIfClaimsPrincipalAlreadyExists">
              An account with this email already exists. Try signing in or resetting your password.
            </Item>
          </Metadata>
          <IncludeInSso>false</IncludeInSso>

          <InputClaims>
            <InputClaim ClaimTypeReferenceId="email" PartnerClaimType="signInNames.emailAddress" Required="true" />
          </InputClaims>

          <PersistedClaims>
            <PersistedClaim ClaimTypeReferenceId="email" PartnerClaimType="signInNames.emailAddress" />
            <PersistedClaim ClaimTypeReferenceId="newPassword" PartnerClaimType="password" />
            <PersistedClaim ClaimTypeReferenceId="displayName" />
            <PersistedClaim ClaimTypeReferenceId="givenName" />
            <PersistedClaim ClaimTypeReferenceId="surname" />
          </PersistedClaims>

          <OutputClaims>
            <OutputClaim ClaimTypeReferenceId="objectId" />
            <OutputClaim ClaimTypeReferenceId="newUser" PartnerClaimType="newClaimsPrincipalCreated" />
            <OutputClaim ClaimTypeReferenceId="authenticationSource" DefaultValue="localAccountAuthentication" />
            <OutputClaim ClaimTypeReferenceId="userPrincipalName" />
            <OutputClaim ClaimTypeReferenceId="signInNames.emailAddress" />
          </OutputClaims>

          <IncludeTechnicalProfile ReferenceId="AAD-Common" />
          <UseTechnicalProfileForSessionManagement ReferenceId="SM-AAD" />
        </TechnicalProfile>

        <!-- 4) Read user by email (NO error if not exists) -->
        <TechnicalProfile Id="AAD-UserReadUsingEmailAddress">
          <DisplayName>Read user by email (no error)</DisplayName>
          <Metadata>
            <Item Key="Operation">Read</Item>
            <Item Key="RaiseErrorIfClaimsPrincipalDoesNotExist">false</Item>
          </Metadata>
          <IncludeInSso>false</IncludeInSso>

          <InputClaims>
            <InputClaim ClaimTypeReferenceId="email" PartnerClaimType="signInNames.emailAddress" Required="true" />
          </InputClaims>

          <OutputClaims>
            <OutputClaim ClaimTypeReferenceId="objectId" />
            <OutputClaim ClaimTypeReferenceId="authenticationSource" DefaultValue="localAccountAuthentication" />
            <OutputClaim ClaimTypeReferenceId="userPrincipalName" />
            <OutputClaim ClaimTypeReferenceId="displayName" />
            <OutputClaim ClaimTypeReferenceId="signInNames.emailAddress" />
          </OutputClaims>

          <IncludeTechnicalProfile ReferenceId="AAD-Common" />
        </TechnicalProfile>

        <!-- Optional but recommended:
             If you want the email prefilled on the SIGN IN page too, ensure your base
             sign-in TP uses {Claim:email}. If you don’t have it, you can override it here.
        -->
        <TechnicalProfile Id="SelfAsserted-LocalAccountSignin-Email-Prefill">
          <DisplayName>Sign in</DisplayName>
          <Protocol Name="Proprietary"
            Handler="Web.TPEngine.Providers.SelfAssertedAttributeProvider, Web.TPEngine, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null" />
          <Metadata>
            <Item Key="ContentDefinitionReferenceId">api.localaccountsignin</Item>
            <Item Key="IncludeClaimResolvingInClaimsHandling">true</Item>
          </Metadata>

          <InputClaims>
            <InputClaim ClaimTypeReferenceId="email" DefaultValue="{Claim:email}" AlwaysUseDefaultValue="true" />
          </InputClaims>

          <!-- Let the base sign-in logic handle validation (if you already have the standard TP, use it instead) -->
          <OutputClaims>
            <OutputClaim ClaimTypeReferenceId="email" />
            <OutputClaim ClaimTypeReferenceId="objectId" />
          </OutputClaims>

          <!-- If you already have the standard “SelfAsserted-LocalAccountSignin-Email” in base,
               remove this TP and just reference the base TP in the journey.
          -->
        </TechnicalProfile>

      </TechnicalProfiles>
    </ClaimsProvider>

  </ClaimsProviders>

  <UserJourneys>
    <UserJourney Id="Onboard_invite_flow">
      <OrchestrationSteps>

        <!-- Step 0: Put email (and optional names) into claims bag -->
        <OrchestrationStep Order="1" Type="ClaimsExchange">
          <ClaimsExchanges>
            <ClaimsExchange Id="GetInviteParams" TechnicalProfileReferenceId="GetInviteParamsFromUrl" />
          </ClaimsExchanges>
        </OrchestrationStep>

        <!-- Step 1: Check if user exists -->
        <OrchestrationStep Order="2" Type="ClaimsExchange">
          <ClaimsExchanges>
            <ClaimsExchange Id="CheckIfUserExists" TechnicalProfileReferenceId="AAD-UserReadUsingEmailAddress" />
          </ClaimsExchanges>
        </OrchestrationStep>

        <!-- Step 2: If NOT exists -> Signup -->
        <OrchestrationStep Order="3" Type="ClaimsExchange">
          <Preconditions>
            <!-- If objectId exists, skip signup -->
            <Precondition Type="ClaimsExist" ExecuteActionsIf="true">
              <Value>objectId</Value>
              <Action>SkipThisOrchestrationStep</Action>
            </Precondition>
          </Preconditions>
          <ClaimsExchanges>
            <ClaimsExchange Id="SignUp" TechnicalProfileReferenceId="SelfAsserted-LocalAccount-Signup-EmailPrefill" />
          </ClaimsExchanges>
        </OrchestrationStep>

        <!-- Step 3: If EXISTS -> Login -->
        <OrchestrationStep Order="4" Type="ClaimsExchange">
          <Preconditions>
            <!-- If objectId does NOT exist, skip login -->
            <Precondition Type="ClaimsExist" ExecuteActionsIf="false">
              <Value>objectId</Value>
              <Action>SkipThisOrchestrationStep</Action>
            </Precondition>
          </Preconditions>
          <ClaimsExchanges>
            <!-- Prefer your base TP if it exists:
                 SelfAsserted-LocalAccountSignin-Email
                 Otherwise use the Prefill override above.
            -->
            <ClaimsExchange Id="LocalAccountLogin" TechnicalProfileReferenceId="SelfAsserted-LocalAccountSignin-Email" />
            <!-- If you don’t have that base TP, swap to:
                 TechnicalProfileReferenceId="SelfAsserted-LocalAccountSignin-Email-Prefill"
            -->
          </ClaimsExchanges>
        </OrchestrationStep>

        <!-- Step 4: Issue token -->
        <OrchestrationStep Order="5" Type="SendClaims" CpimIssuerTechnicalProfileReferenceId="JwtIssuer" />

      </OrchestrationSteps>
    </UserJourney>
  </UserJourneys>

  <RelyingParty>
    <DefaultUserJourney ReferenceId="Onboard_invite_flow" />
    <TechnicalProfile Id="PolicyProfile">
      <DisplayName>PolicyProfile</DisplayName>
      <Protocol Name="OpenIdConnect" />
      <OutputClaims>
        <OutputClaim ClaimTypeReferenceId="objectId" />
        <OutputClaim ClaimTypeReferenceId="email" />
        <OutputClaim ClaimTypeReferenceId="displayName" />
        <OutputClaim ClaimTypeReferenceId="givenName" />
        <OutputClaim ClaimTypeReferenceId="surname" />
      </OutputClaims>
      <SubjectNamingInfo ClaimType="sub" />
    </TechnicalProfile>
  </RelyingParty>

</TrustFrameworkPolicy>
